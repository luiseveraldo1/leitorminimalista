<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowRead - Leitor Inteligente</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f5f7fa; --card-bg-color: #ffffff; --text-color: #2c3e50;
            --heading-color: #1a2533; --primary-color: #4a69bd; --primary-hover-color: #3b5496;
            --secondary-color: #788a9e; --border-color: #dfe4ea; --shadow-color: rgba(0, 0, 0, 0.07);
            --success-color: #27ae60; --font-family: 'Poppins', 'Segoe UI', sans-serif;
            --border-radius: 16px; --card-padding: 25px;
        }
        body.dark-mode {
            --bg-color: #1a2533; --card-bg-color: #2c3e50; --text-color: #e0e5eb;
            --heading-color: #ffffff; --border-color: #41546b; --shadow-color: rgba(0, 0, 0, 0.15);
        }
        body { font-family: var(--font-family); background: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; transition: background 0.3s, color 0.3s; }
        .container { width: 100%; max-width: 1400px; display: grid; grid-template-columns: 400px 1fr; gap: 25px; }
        header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        header h1 { color: var(--heading-color); margin: 0; font-size: 2.2rem; }
        header h1 span { color: var(--primary-color); }
        .controls-column { display: flex; flex-direction: column; gap: 25px; }
        .card { background: var(--card-bg-color); border-radius: var(--border-radius); padding: var(--card-padding); box-shadow: 0 8px 30px var(--shadow-color); transition: all 0.3s ease; }
        .card h3 { margin: 0 0 15px 0; color: var(--heading-color); font-size: 1.1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        textarea, input[type="text"], input[type="number"], select { width: 100%; padding: 12px 15px; border-radius: 10px; border: 1px solid var(--border-color); font-size: 15px; background: var(--bg-color); color: var(--text-color); transition: all 0.2s ease; box-sizing: border-box; margin-bottom: 10px; }
        textarea:focus, input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent); }
        #rawText { height: 120px; resize: vertical; }
        #processedText { height: 150px; resize: vertical; margin-top: 15px;}
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; }
        button { background-color: var(--primary-color); color: #fff; border: none; border-radius: 10px; cursor: pointer; font-weight: 500; padding: 10px 15px; font-size: 15px; font-family: inherit; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; }
        button:hover { background-color: var(--primary-hover-color); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        .alignment-btn { background-color: var(--secondary-color); flex-grow: 1; }
        .alignment-btn.active { background-color: var(--primary-hover-color); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        button.secondary { background-color: var(--secondary-color); }
        button.secondary:hover { background-color: #5f7184; }
        button.success { background-color: var(--success-color); }
        button.success:hover { background-color: #219a52; }
        label { display: block; margin-bottom: 5px; font-weight: 500; } .config-group { display: flex; gap: 15px; align-items: center; margin-bottom: 10px; } .config-group label { margin-bottom: 0; } .config-group input, .config-group select { margin-bottom: 0; }
        .reader-column { display: flex; flex-direction: column; gap: 25px; }
        
        .motivation { color: var(--success-color); font-weight: bold; animation: fadeIn 0.8s ease-in-out; } @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* --- ESTILO DO DARK MODE E AUTO MODE TOGGLE (UNIFICADO) --- */
        .switch { 
            position: relative; 
            display: inline-block; 
            width: 60px; 
            height: 34px; 
            margin: 0 5px; /* Pequeno espa√ßamento lateral */
        } 
        .switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        } 
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: var(--secondary-color); 
            transition: .4s; 
            border-radius: 34px; 
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        } 
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 26px; 
            width: 26px; 
            left: 4px; 
            bottom: 4px; 
            background-color: white; 
            transition: .4s; 
            border-radius: 50%; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        } 
        /* Cor de Ativo (padr√£o para ambos os switches) */
        input:checked + .slider { 
            background-color: var(--primary-color); 
        } 
        input:checked + .slider:before { 
            transform: translateX(26px); 
        }
        /* √çcones para o Dark Mode */
        #darkModeToggle:not(:checked) + .slider:after { content: '‚òÄÔ∏è'; position: absolute; top: 50%; right: 8px; transform: translateY(-50%); font-size: 14px; transition: opacity 0.4s; }
        #darkModeToggle:checked + .slider:after { content: 'üåô'; position: absolute; top: 50%; left: 8px; transform: translateY(-50%); font-size: 14px; color: #fff; transition: opacity 0.4s; right: auto; }
        /* √çcones para o Auto Mode */
        #autoModeSwitch:not(:checked) + .slider:after { content: 'M'; position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 14px; font-weight: bold; color: white; transition: opacity 0.4s; }
        #autoModeSwitch:checked + .slider { background-color: var(--success-color); }
        #autoModeSwitch:checked + .slider:after { content: 'A'; position: absolute; top: 50%; left: 10px; transform: translateY(-50%); font-size: 14px; font-weight: bold; color: white; transition: opacity 0.4s; right: auto; }


        /* --- CORRE√á√ÉO DO FLEXBOX VERTICAL E LATERAL (CONTROLES DE LEITURA) --- */
        
        .reader-container {
            display: flex; 
            gap: 25px; 
            align-items: flex-start; 
            width: 100%; 
        }
        
        .reader-container #output { 
            flex-grow: 1; 
            min-height: 350px; 
            padding: 50px; 
            background: var(--card-bg-color); 
            border-radius: var(--border-radius);
            box-shadow: 0 8px 30px var(--shadow-color);
            font-size: 28px; 
            line-height: 1.6;
            color: var(--heading-color);
            display: flex; 
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow-wrap: break-word; 
            white-space: pre-wrap;
            border: 1px solid var(--border-color);
        }

        .controls-vertical {
            display: flex;
            flex-direction: column; 
            gap: 10px; 
            padding: 15px 10px; 
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px var(--shadow-color);
            align-self: flex-start; 
            flex-shrink: 0; 
        }
        
        .controls-vertical button {
            width: 50px; 
            height: 50px; 
            font-size: 1.4em; 
            border-radius: 50%; 
            background-color: var(--primary-color);
            color: white;
            padding: 0; 
            display: flex; 
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: none; 
            line-height: 1; 
        }
        .controls-vertical button:hover {
            background-color: var(--primary-hover-color);
            transform: scale(1.05); 
        }

        /* O bot√£o AutoMode antigo foi substitu√≠do por um switch no card de Configura√ß√µes */
        
        .search-container button {
            width: 50px; 
            height: 50px; 
            font-size: 1.2em; 
            border-radius: 50%; 
            padding: 0;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .search-container input {
            margin-bottom: 0; 
        }
        
        /* --- ESTILOS DO MODAL/EDITOR MANUAL --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            max-width: 800px;
            width: 90%;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-header h3 {
            margin: 0;
            color: var(--heading-color);
        }
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--secondary-color);
            transition: color 0.2s;
        }
        .modal-close-btn:hover {
            color: var(--primary-color);
        }
        .editor-list {
            padding: 20px 25px;
            overflow-y: auto;
            flex-grow: 1;
        }
        .editor-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
        }
        .editor-item p {
            flex-grow: 1;
            margin: 0;
            padding: 5px;
            border-radius: 4px;
            min-height: 1.2em;
            outline: none;
            color: var(--text-color);
            transition: background-color 0.2s;
        }
        .editor-item p:focus {
            background-color: color-mix(in srgb, var(--primary-color) 5%, transparent);
            border: 1px dashed var(--primary-color);
        }
        .delete-period-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 1.1em;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .delete-period-btn:hover {
            background-color: #c0392b;
            transform: none;
            box-shadow: none;
        }
        .editor-footer {
            padding: 15px 25px;
            border-top: 1px solid var(--border-color);
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Flow<span>Read</span></h1>
            <label class="switch">
                <input type="checkbox" id="darkModeToggle">
                <span class="slider"></span>
            </label>
        </header>

        <aside class="controls-column">
            <div class="card">
                <h3>1. Insira seu Texto <span id="rawTextCounter" class="secondary" style="font-size: 0.8rem; font-weight: 400; color: var(--secondary-color);"></span></h3>
               <textarea id="rawText" rows="6" placeholder="Cole seu texto aqui..." oninput="updateCounters()"></textarea>
                <div class="button-group">
                    <button onclick="pasteFromClipboard()">üìã Colar</button>
                    <button onclick="openManualEditor()">‚úÇÔ∏è Editar Texto</button>
                    <button onclick="importFromLink()">üìé Importar de Link</button>
                    <button onclick="clearRawText()" class="secondary">üóëÔ∏è Limpar</button>
                </div>
				
				
				<div style="margin-top: 15px;">
                    <label for="summaryPercent">Tamanho do Resumo (em % de frases)</label>
                    <input type="number" id="summaryPercent" value="25" min="5" max="80" step="5" style="width: 100px; display: inline-block;">
                </div>

                <div class="button-group" style="margin-top: 15px;">
                    <button onclick="generateSentences()">üìå Gerar Frases</button>
                    <button onclick="generateSmartSummary()">üìù Resumo Inteligente</button>
                </div>
            </div>
            <div class="card">
               <h3>2. Revise e Edite <span id="processedTextCounter" class="secondary" style="font-size: 0.8rem; font-weight: 400; color: var(--secondary-color);"></span></h3>
                <textarea id="processedText" placeholder="Frases extra√≠das ou resumidas aparecer√£o aqui." oninput="updateCounters()"></textarea>
                <div class="button-group">
                    <button onclick="syncProcessedText()">üîÑ Sincronizar Edi√ß√µes</button>
                </div>
            </div>
            <div class="card">
                <h3>‚öôÔ∏è Configura√ß√µes de Leitura</h3>
                <label for="voiceSelect">Voz</label>
                <select id="voiceSelect"></select>
                <div class="config-group" style="margin-bottom: 20px;">
                    <label style="font-weight: bold;">Modo Autom√°tico:</label>
                    <label class="switch" style="margin-left: auto;">
                         <input type="checkbox" id="autoModeSwitch" onclick="toggleAutoMode()">
                         <span class="slider"></span>
                    </label>
                </div>

                <div class="config-group">
                    <label>Velocidade: <input type="number" id="voiceRate" value="1" min="0.1" max="3" step="0.1"></label>
                    <label>Tamanho: <input type="number" id="fontSize" value="28" min="12" max="60"></label>
                </div>
                <div class="config-group">
                    <label for="fontColor">Cor:</label>
                    <input type="color" id="fontColor" value="#1a2533">
                </div>
                <label for="fontFamily">Fonte</label>
                <select id="fontFamily">
                  <option value="Poppins, sans-serif">Poppins</option>
                  <option value="Georgia, serif">Georgia</option>
                  <option value="Arial, sans-serif">Arial</option>
                  <option value="Courier New, monospace">Courier New</option>
                  <option value="Verdana, sans-serif">Verdana</option>
                </select>
                <label style="margin-top: 15px;">Alinhamento do Texto</label>
                <div class="button-group">
                    <button class="alignment-btn" onclick="alignText('left', this)">Esquerda</button>
                    <button class="alignment-btn" onclick="alignText('justify', this)">Justificar</button>
                    <button class="alignment-btn" onclick="alignText('right', this)">Direita</button>
                </div>
                <label style="margin-top: 15px;">Frases Motivacionais</label>
                <div class="config-group">
                    <label>A cada <input type="number" id="motivationEvery" value="0" min="0" style="width:60px"> frases</label>
                </div>
            </div>
            <div class="card">
                <h3>üíæ Gerenciamento</h3>
                <div class="button-group">
                    <button onclick="exportJSON()">üì• Exportar JSON</button>
                    <label for="importFile" class="button secondary" style="cursor:pointer;">üì§ Importar JSON</label>
                    <input type="file" id="importFile" onchange="importJSON(event)" style="display:none;">
                </div>
                 <div class="button-group" style="margin-top: 10px;">
                    <button onclick="saveToCloud()" class="success">‚òÅÔ∏è Salvar e Copiar Link</button>
                    <button onclick="loadBinByLink()">üìÇ Carregar da Nuvem</button>
                </div>
            </div>
        </aside>

        <main class="reader-column">
            <div class="reader-container">
                <div id="output">
                    Bem-vindo ao FlowRead! Cole um texto e gere frases para come√ßar.
                </div>

                <div class="controls-vertical">
                    <button id="playPauseBtn" onclick="playPauseToggle()" title="Play/Pause">‚ñ∂Ô∏è</button>
                    <button id="stopBtn" onclick="stopReading()" title="Parar Leitura">‚èπÔ∏è</button>
                    <button id="nextBtn" onclick="nextSentence()" title="Pr√≥xima Frase">‚è≠Ô∏è</button>
                    <button id="prevBtn" onclick="prevSentence()" title="Frase Anterior">‚èÆÔ∏è</button>
                    
                    <button id="voiceToggleBtn" onclick="toggleVoice()" title="Voz On/Off">üó£Ô∏è</button>
                    </div>
            </div>	
			
            <div class="card">
                 <h3>Pesquisa R√°pida</h3>
                 <div class="search-container" style="display: flex; gap: 10px; align-items: center;">
                     <input type="text" id="searchInput" placeholder="Pesquisar termo no Google...">
                     <button onclick="searchGoogle()">üîç</button>
                 </div>
            </div>
        </main>
    </div>

    <div id="manual-editor-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content editor-modal">
            <div class="modal-header">
                <h3>Editor de Per√≠odos</h3>
                <button class="modal-close-btn" onclick="closeManualEditor()">&times;</button>
            </div>
            <div id="editor-list" class="editor-list"></div>
            <div class="editor-footer">
                <button class="success" onclick="saveManualChanges()">‚úì Salvar Altera√ß√µes e Fechar</button>
            </div>
        </div>
    </div>

<script>
// =======================================================
// L√ìGICA DO DARK MODE E OUTRAS MELHORIAS
// =======================================================
document.addEventListener('DOMContentLoaded', () => {
    const darkModeToggle = document.getElementById('darkModeToggle');
    const body = document.body;
    const fontColorInput = document.getElementById('fontColor');
    
    function applyTheme(isDark) {
        if (isDark) {
            body.classList.add('dark-mode');
            // S√≥ muda a cor se a cor atual for a padr√£o Light
            if (fontColorInput.value === '#1a2533') { 
                fontColorInput.value = '#ffffff'; 
            }
        } else {
            body.classList.remove('dark-mode');
            // S√≥ muda a cor se a cor atual for a padr√£o Dark
            if (fontColorInput.value === '#ffffff') { 
                fontColorInput.value = '#1a2533'; 
            }
        }
    }
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    if(darkModeToggle) {
        darkModeToggle.checked = prefersDark;
        applyTheme(prefersDark);
        darkModeToggle.addEventListener('change', () => {
            applyTheme(darkModeToggle.checked);
            if (typeof showCurrent === 'function') showCurrent();
        });
    }
    loadVoices();
	const rawTextarea = document.getElementById('rawText');
    if (rawTextarea && rawTextarea.value.trim() === '') {
        rawTextarea.value = `O rover Curiosity, da NASA, pousou em Marte em 2012 para investigar o passado geol√≥gico do planeta.
A miss√£o do Curiosity √© determinar se Marte j√° teve as condi√ß√µes ambientais necess√°rias para sustentar vida microbiana.
Para isso, o Curiosity explora a cratera Gale, onde ele tem coletado amostras de solo e rochas.
Recentemente, o Curiosity encontrou evid√™ncias de √°gua e compostos org√¢nicos, o que refor√ßa a possibilidade de vida no passado de Marte.
O Curiosity continua sua explora√ß√£o, enviando dados valiosos sobre a hist√≥ria do planeta vermelho.`;
    }
	updateCounters(); 
    // Garante que o estado do switch seja refletido no JS
    document.getElementById('autoModeSwitch').checked = autoMode;
});

// =======================================================
// VARI√ÅVEIS GLOBAIS E CONSTANTES
// =======================================================
let sentences=[], currentIndex=0, autoMode=false, voiceEnabled=true;
let voices=[], selectedVoice=null, textReadCounts={};
let cloudLink = "";
const output=document.getElementById('output'); 
const voiceSelect=document.getElementById('voiceSelect');
const rawTextArea = document.getElementById('rawText');
const motivationalPhrases=["Continue firme, voc√™ est√° indo bem!","Mais uma frase! Foque e avance!","Voc√™ est√° se superando a cada leitura!","Mantenha o ritmo, sua mente agradece!","A const√¢ncia traz o resultado!","Respire fundo, voc√™ est√° no caminho certo!","Seu foco est√° criando resultados!"];

function sent_tokenize_browser(text) {
    return text.match(/[^.!?]+[.!?]+/g) || [text.trim()];
}

const stopWordsPt = new Set([
¬† ¬† 'de', 'do', 'da', 'e', 'a', 'o', 'que', 'em', 'um', 'uma', 'para', 'com', 'n√£o', 'se', 'por', 'os', 'as', 'no', 'na', 'dos', 'das',
¬† ¬† 'ao', 'aos', 'meu', 'minha', 'seu', 'sua', 'nosso', 'nossa', 'dele', 'dela', 'este', 'esta', 'isto',¬†
¬† ¬† 'aquele', 'aquela', 'aquilo', 'ser', 'foi', 'fui', 'somos', 'sou', 's√£o', 'voc√™',¬†
¬† ¬† 'ele', 'ela', 'n√≥s', 'v√≥s', 'eles', 'elas', 'que', 'quem', 'onde', 'qual', 'quais',
¬† ¬† '.', ',', ':', ';', '!', '?', '(', ')', '[', ']', '{', '}', '"', "'", '-', '‚Äî',¬†
¬† ¬† '0', '1', '2', '3', '4', '5', '6', '7', '8', '9'
]);

function calcularTermFrequency(texto) {
    const frequencia = {};
    const palavras = texto.toLowerCase().split(/[\s\n]+/);
    for (let palavra of palavras) {
        const palavraLimpa = palavra.replace(/[.,:;!?()"']/g, ''); 
        if (palavraLimpa.length > 1 && !stopWordsPt.has(palavraLimpa)) {
            frequencia[palavraLimpa] = (frequencia[palavraLimpa] || 0) + 1;
        }
    }
    const maxFrequencia = Math.max(...Object.values(frequencia));
    if (maxFrequencia === 0) return {};
    for (let palavra in frequencia) {
        frequencia[palavra] /= maxFrequencia;
    }
    return frequencia;
}

function calcularInverseSentenceFrequency(frases, tf) {
    const isf = {};
    const totalFrases = frases.length;
    const contagemFrases = {};
    for (const frase of frases) {
        const palavrasUnicas = new Set();
        frase.toLowerCase().split(/[\s\n]+/).forEach(w => {
            const palavraLimpa = w.replace(/[.,:;!?()"']/g, '');
            if (tf[palavraLimpa]) {
                palavrasUnicas.add(palavraLimpa);
            }
        });
        palavrasUnicas.forEach(palavra => {
            contagemFrases[palavra] = (contagemFrases[palavra] || 0) + 1;
        });
    }
    for (const palavra in contagemFrases) {
        isf[palavra] = Math.log10(totalFrases / contagemFrases[palavra]);
    }
    return isf;
}

function aplicarPesoEstrutural(pontuacaoFrases, totalFrases) {
    const pesoPercentual = 0.2; 
    const numFrasesBonus = Math.ceil(totalFrases * pesoPercentual);
    const bonus = 0.25; 
    for (let i = 0; i < totalFrases; i++) {
        let b = 0;
        if (i < numFrasesBonus) {
            b = pontuacaoFrases[i] * bonus; 
        } else if (i >= totalFrases - numFrasesBonus) {
            b = pontuacaoFrases[i] * bonus;
        }
        pontuacaoFrases[i] += b;
    }
    return pontuacaoFrases; 
}

function gerarResumo(textoOriginal) {
¬† ¬† const frases = sent_tokenize_browser(textoOriginal.trim());
¬† ¬† const totalFrases = frases.length;
¬† ¬† const percentual = document.getElementById('summaryPercent')?.value || 25;¬†
¬† ¬† let numFrasesDesejadas = Math.ceil(totalFrases * (percentual / 100));
¬† ¬† numFrasesDesejadas = Math.max(1, numFrasesDesejadas);
¬† ¬† const frasesParaExtrair = Math.min(totalFrases, numFrasesDesejadas);
¬† ¬† if (totalFrases === 0) { return "Texto muito curto ou sem palavras relevantes."; }
    const tf = calcularTermFrequency(textoOriginal);
¬† ¬† if (Object.keys(tf).length === 0) { return "Texto muito curto ou sem palavras relevantes."; }
    const isf = calcularInverseSentenceFrequency(frases, tf);
    const pontuacaoPalavras = {};
    for (const palavra in tf) { pontuacaoPalavras[palavra] = tf[palavra] * (isf[palavra] || 0); }
¬† ¬† const pontuacaoFrases = {};
¬† ¬† frases.forEach((frase, i) => {
¬† ¬† ¬† ¬† let score = 0;
¬† ¬† ¬† ¬† frase.toLowerCase().split(/[\s\n]+/).forEach(w => {
¬† ¬† ¬† ¬† ¬† ¬† const palavraLimpa = w.replace(/[.,:;!?()"']/g, '');
¬† ¬† ¬† ¬† ¬† ¬† score += (pontuacaoPalavras[palavraLimpa] || 0); 
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† pontuacaoFrases[i] = score;
¬† ¬† });
¬† ¬† const pontuacaoFinal = aplicarPesoEstrutural(pontuacaoFrases, totalFrases);
¬† ¬† const frasesOrdenadas = Object.keys(pontuacaoFinal)
¬† ¬† ¬† ¬† .map(i => [parseInt(i), pontuacaoFinal[i]])
¬† ¬† ¬† ¬† .sort((a, b) => b[1] - a[1]);
¬† ¬† const indicesResumo = frasesOrdenadas
¬† ¬† ¬† ¬† .slice(0, frasesParaExtrair)
¬† ¬† ¬† ¬† .map(item => item[0])
¬† ¬† ¬† ¬† .sort((a, b) => a - b);
¬† ¬† const resumo = indicesResumo
¬† ¬† ¬† ¬† .map(i => frases[i].trim())
¬† ¬† ¬† ¬† .join(' ');
¬† ¬† return resumo;
}

function loadVoices(){     
    voices=speechSynthesis.getVoices();     
    if(!voiceSelect) return;    
    voiceSelect.innerHTML="";     
    
    // Adiciona a op√ß√£o "Autom√°tico" como primeiro item
    let defaultOption = document.createElement("option");
    defaultOption.value = -1;
    defaultOption.textContent = "Autom√°tico (Padr√£o do Sistema)";
    voiceSelect.appendChild(defaultOption);

    voices.forEach((v,i)=>{         
        let o=document.createElement("option");         
        o.value=i; o.textContent=`${v.name} (${v.lang})`;         
        voiceSelect.appendChild(o);     
    });     
    
    // Se n√£o houver vozes (excluindo a 'Autom√°tico'), o selectedVoice fica null
    if(voices.length > 0) {
        selectedVoice = voices[0];
        voiceSelect.value = 0; // Seleciona a primeira voz da lista
    } else {
        selectedVoice = null;
        voiceSelect.value = -1; // Seleciona a op√ß√£o Autom√°tico
    }
}

// Atualiza o event listener para tratar o valor -1 (Autom√°tico)
if(voiceSelect) voiceSelect.addEventListener("change",()=>{ 
    const index = parseInt(voiceSelect.value);
    selectedVoice = (index === -1 || index >= voices.length) ? null : voices[index]; 
});

function generateSentences(){ 
    stopReading(); 
    const text=document.getElementById('rawText').value; 
    if(!text.trim()) return; 
    sentences=sent_tokenize_browser(text).map(s=>s.trim()).filter(Boolean); 
    sentences=insertMotivation(sentences); 
    currentIndex=0; 
    document.getElementById('processedText').value=sentences.join("\n\n"); 
    showCurrent(); 
}

function generateSmartSummary(){ 
    stopReading(); 
    const text=document.getElementById('rawText').value; 
    if(!text.trim()) return; 
    const resumoText = gerarResumo(text);
    if (resumoText.includes("muito curto")) {
        alert("O texto √© muito curto ou n√£o tem palavras suficientes para resumir.");
        return;
    }
    document.getElementById('processedText').value = resumoText;
    sentences = sent_tokenize_browser(resumoText).map(s=>s.trim()).filter(Boolean);
    sentences = insertMotivation(sentences);
    currentIndex=0;
    alert(`Resumo gerado com sucesso! ${sentences.length} frases selecionadas.`);
    showCurrent();
	updateCounters();
}

function syncProcessedText(){ 
    stopReading(); 
    const edited=document.getElementById('processedText').value; 
    sentences=edited.split(/\n\s*\n/).map(s=>s.trim()).filter(Boolean); 
    currentIndex=0; 
    showCurrent(); 
    updateCounters(); 
}

function insertMotivation(arr){ const every=parseInt(document.getElementById('motivationEvery').value)||0; if(every<=0) return arr; let final=[]; for(let i=0;i<arr.length;i++){ final.push(arr[i]); if((i+1)%every===0 && i!==arr.length-1){ final.push(motivationalPhrases[Math.floor(Math.random()*motivationalPhrases.length)]); } } return final; }

function clearRawText(){ 
    stopReading(); 
    document.getElementById('rawText').value=""; 
    document.getElementById('processedText').value=""; 
    sentences=[]; 
    output.textContent="Texto apagado."; 
    updateCounters();
}

function searchGoogle(){ const q=document.getElementById('searchInput').value.trim(); if(q) window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`, "_blank"); else { alert("Digite algo para pesquisar."); document.getElementById('searchInput').focus(); } }

async function importFromLink(){ const url=prompt("Cole o link do site (modo texto recomendado):"); if(!url) return; try{ const res=await fetch(`http://localhost:3000/extract-text?url=${encodeURIComponent(url)}`); const data=await res.json(); if(data.text){ document.getElementById('rawText').value=data.text; alert("Texto extra√≠do com sucesso!"); } else alert("N√£o foi poss√≠vel extrair o texto."); } catch(err){ alert("Erro ao importar o texto: "+err.message); } }

function showCurrent(){ 
    // Se n√£o houver frases, exibe mensagem de erro.
    if(!sentences || !sentences.length){ 
        output.textContent="Nenhuma frase gerada."; 
        return; 
    } 
    
    // Configura estilos
    const fontSize = document.getElementById('fontSize')?.value || 28; 
    const fontColor = document.getElementById('fontColor')?.value || '#1a2533'; 
    const fontFamily = document.getElementById('fontFamily')?.value || 'Poppins, sans-serif'; 
    output.style.fontSize=fontSize + "px"; 
    output.style.color=fontColor; 
    output.style.fontFamily=fontFamily; 
    output.style.textAlign = output.style.textAlign || 'center'; 
    
    // Exibe a frase atual, aplicando estilo se for motivacional
    const text=sentences[currentIndex]; 
    if(motivationalPhrases.includes(text)) {
        output.innerHTML=`<span class="motivation">${text}</span>`; 
    } else {
        output.textContent=text;
    }
    
    // ‚ùå REMOVIDO: L√≥gica que redefinia o √≠cone do Play/Pause.
    // Isso deve ser tratado apenas nas fun√ß√µes de controle de voz.
}

function alignText(alignment, clickedButton) { 
    document.getElementById('output').style.textAlign = alignment; 
    document.querySelectorAll('.alignment-btn').forEach(btn => btn.classList.remove('active')); 
    clickedButton.classList.add('active');
}

function speakCurrent() { 
    const text = sentences[currentIndex]; 
    
    // Verifica se pode falar (apenas voz ativada e texto v√°lido). Permite selectedVoice=null (Autom√°tico).
    if (!voiceEnabled || !text.trim()) { 
        if (autoMode) nextSentenceAuto(); 
        return; 
    } 
    
    speechSynthesis.cancel(); 
    
    const utter = new SpeechSynthesisUtterance(text); 
    
    // Se uma voz espec√≠fica foi selecionada (selectedVoice N√ÉO √© null), define utter.voice.
    // Caso contr√°rio (Autom√°tico), usa a voz padr√£o do sistema.
    if (selectedVoice) {
        utter.voice = selectedVoice;
    }
    
    const rate = parseFloat(document.getElementById('voiceRate')?.value) || 1; 
    utter.rate = rate; 
    
    // --- Foco e Estilo de In√≠cio/Fim (Mantidos) ---
    utter.onstart = () => {
        document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è';
        // Adiciona um estilo sutil de "lendo"
        output.style.border = '3px solid var(--primary-color)';
        output.style.boxShadow = '0 0 20px color-mix(in srgb, var(--primary-color) 40%, transparent)';
    };
    
    utter.onend = () => { 
        // Remove o estilo de "lendo"
        output.style.border = '1px solid var(--border-color)';
        output.style.boxShadow = '0 8px 30px var(--shadow-color)';

        if (autoMode) {
            // Pequeno atraso para o √°udio realmente terminar antes de avan√ßar
            setTimeout(nextSentenceAuto, 200); 
        } else {
            document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è'; 
        }
    }; 
    
    // Trata erros de voz
    utter.onerror = (event) => {
        console.error('SpeechSynthesis Error:', event.error);
        alert(`Erro de voz: ${event.error}. Tentando avan√ßar...`);
        document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è'; 
        if (autoMode) nextSentenceAuto();
    };

    // Certifica que a voz est√° ativada e tenta falar
    if ('speechSynthesis' in window && !speechSynthesis.speaking) {
         speechSynthesis.speak(utter);
    } else if (speechSynthesis.speaking) {
         // Se j√° estiver falando, apenas cancela e come√ßa a nova fala
         speechSynthesis.cancel();
         speechSynthesis.speak(utter);
    }
}
// ‚ö†Ô∏è CORRIGIDO: O Play/Pause n√£o liga mais o autoMode por padr√£o
function playPauseToggle() {
    if (!sentences.length) {
        alert("Gere frases primeiro!");
        return;
    }
    
    if (speechSynthesis.speaking && !speechSynthesis.paused) {
        speechSynthesis.pause();
        document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è';
    } else if (speechSynthesis.paused) {
        speechSynthesis.resume();
        document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è';
    } else {
        // Se n√£o estiver falando nem pausado, inicia a leitura na frase atual.
        // N√£o altera o estado do autoMode.
        if (currentIndex < 0 || currentIndex >= sentences.length) currentIndex = 0;
        showCurrent(); 
        speakCurrent(); 
    }
}

function stopReading() {
    // Cancela a s√≠ntese de voz (para a leitura)
    speechSynthesis.cancel();
    
    // Garante que o √≠cone volte para PLAY.
    document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è'; 
    
    // NOVIDADE: Remove explicitamente o estilo visual de "lendo" que a fun√ß√£o speakCurrent() aplica.
    const output = document.getElementById('output');
    output.style.border = '1px solid var(--border-color)'; // Volta para a borda padr√£o
    // O valor da sombra padr√£o √© '0 8px 30px var(--shadow-color)'
    output.style.boxShadow = '0 8px 30px var(--shadow-color)'; 
}

// ‚öôÔ∏è CORRIGIDO: Fun√ß√£o de toggle do Switch
function toggleAutoMode() {
    autoMode = document.getElementById('autoModeSwitch').checked;
    
    if (autoMode) {
        // Se ligar, inicia a leitura (se n√£o estiver lendo)
        if (!speechSynthesis.speaking && !speechSynthesis.paused) {
            if (currentIndex < 0 || currentIndex >= sentences.length) currentIndex = 0;
            showCurrent();
            speakCurrent();
        }
    } else {
        // Se desligar o autoMode, para qualquer leitura em andamento
        speechSynthesis.cancel();
        document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è'; 
    }
}

function nextSentenceAuto(){ 
    if(!autoMode || !sentences.length) return; 
    currentIndex=(currentIndex+1)%sentences.length; 
    showCurrent(); 
    speakCurrent(); 
}

// ‚è≠Ô∏è CORRIGIDO: Navega√ß√£o manual (para a voz e avan√ßa/recua)
function nextSentence(){ 
    if (!sentences.length) return; 
    speechSynthesis.cancel(); // Para a voz imediatamente
    document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è'; 

    currentIndex=(currentIndex+1)%sentences.length; 
    showCurrent(); 
}

// ‚èÆÔ∏è CORRIGIDO: Navega√ß√£o manual (para a voz e avan√ßa/recua)
// ‚èÆÔ∏è CORRIGIDO: Navega√ß√£o manual (para a voz e avan√ßa/recua)
function prevSentence(){ 
    if (!sentences.length) return; 
    speechSynthesis.cancel(); // Para a voz imediatamente
    document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è'; 

    // --- MUDAN√áA: Navega√ß√£o Circular ---
    // (currentIndex - 1 + sentences.length) garante que -1 se torne sentences.length - 1
    currentIndex = (currentIndex - 1 + sentences.length) % sentences.length; 
    showCurrent(); 
}

function toggleVoice(){ 
    voiceEnabled=!voiceEnabled; 
    const voiceBtn = document.getElementById('voiceToggleBtn');
    if (voiceBtn) {
        voiceBtn.textContent = voiceEnabled ? 'üó£Ô∏è' : 'üîá';
    }
    if (!voiceEnabled && (speechSynthesis.speaking || speechSynthesis.paused)) {
        speechSynthesis.cancel();
        document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è'; 
        alert("Voz desativada. Leitura de texto interrompida.");
    } else if (voiceEnabled) {
         alert("Voz ativada.");
    }
}

function exportJSON(){ const data={sentences,textReadCounts:{}}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='flowread_data.json'; a.click(); URL.revokeObjectURL(url); }

function importJSON(event){ const file=event.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=(e)=>{ try{ const data=JSON.parse(e.target.result); if(data.sentences) sentences=data.sentences; if(data.textReadCounts) textReadCounts=data.textReadCounts; currentIndex=0; document.getElementById('processedText').value=sentences.join("\n\n"); showCurrent(); alert("JSON importado com sucesso!"); }catch(err){ alert("Erro ao importar JSON: "+err); } }; reader.readAsText(file); }

const MASTER_KEY="$2a$10$2wR5NQoVsUWczmL.U8MAs.YILi4/aKD3YK01iPbnyFzfLn.xiChGK";
async function saveToCloud(){ try{ const data={sentences,textReadCounts:{}}; const res=await fetch("https://api.jsonbin.io/v3/b",{method:"POST",headers:{"Content-Type":"application/json","X-Master-Key":MASTER_KEY},body:JSON.stringify(data)}); const json=await res.json(); cloudLink=json.metadata.id; copyCloudLink(); } catch(err){ alert("Erro ao salvar na nuvem: "+err.message); }}
function copyCloudLink(){ if(!cloudLink){ alert("Nenhum JSON salvo ainda."); return; } const url="https://jsonbin.io/b/"+cloudLink; navigator.clipboard.writeText(url).then(()=>alert("Salvo! Link copiado."),()=>alert("Falha ao copiar."));}
async function loadBinByLink(){ const input = prompt("Cole o ID ou link do bin JSON:"); if(!input) return; let binId = input.includes("jsonbin.io") ? input.split("/b/")[1].split("/")[0] : input; try{ const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, { headers: {"X-Master-Key": MASTER_KEY} }); const json = await res.json(); if(json.record){ sentences = json.record.sentences || []; textReadCounts = json.record.textReadCounts || {}; currentIndex = 0; document.getElementById('processedText').value = sentences.join("\n\n"); showCurrent(); alert("Bin carregado com sucesso!"); } else alert("N√£o foi poss√≠vel carregar o bin."); } catch(err){ alert("Erro ao carregar bin: "+err.message); }}

async function pasteFromClipboard() {    try {        const text = await navigator.clipboard.readText();        if (text) {            document.getElementById('rawText').value = text;        } else {            alert('Sua √°rea de transfer√™ncia est√° vazia.');
        }    } catch (err) {        console.error('Falha ao colar texto: ', err);        alert('N√£o foi poss√≠vel ler da √°rea de transfer√™ncia.');    }}

// =======================================================
// FUN√á√ïES DO EDITOR MANUAL
// =======================================================
function openManualEditor() {    
    const editorList = document.getElementById('editor-list');    
    const manualEditorModal = document.getElementById('manual-editor-modal');    
    const text = rawTextArea.value;    
    
    if (!text.trim()) {        
        alert('A caixa de texto est√° vazia.');
        return;
    }
    
    const periods = sent_tokenize_browser(text).map(s => s.trim()).filter(Boolean);
    editorList.innerHTML = '';
    
    periods.forEach(period => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'editor-item';
        itemDiv.innerHTML = `<p contenteditable="true">${period}</p><button class="delete-period-btn" onclick="this.parentElement.remove()" title="Apagar este per√≠odo">&times;</button>`;
        editorList.appendChild(itemDiv);
    });
    
    manualEditorModal.style.display = 'flex';
}

function closeManualEditor() {    
    document.getElementById('manual-editor-modal').style.display = 'none';
}

function saveManualChanges() {    
    const editorList = document.getElementById('editor-list');    
    const remainingItems = editorList.querySelectorAll('.editor-item p');    
    let newText = [];    
    
    remainingItems.forEach(item => newText.push(item.textContent.trim()));    
    
    rawTextArea.value = newText.join(' '); 
    
    closeManualEditor();
    updateCounters(); 
}
// =======================================================

function countWords(text) {
    const cleanText = text.trim().replace(/\s+/g, ' ');
    if (cleanText === '') return 0;
    return cleanText.split(' ').length;
}

function updateCounters() {
    const rawText = document.getElementById('rawText').value;
    const processedText = document.getElementById('processedText').value;

    const rawCharCount = rawText.length;
    const rawWordCount = countWords(rawText);
    
    const processedCharCount = processedText.length;
    const processedWordCount = countWords(processedText);

    document.getElementById('rawTextCounter').textContent = `(${rawWordCount} palavras, ${rawCharCount} caracteres)`;
    document.getElementById('processedTextCounter').textContent = `(${processedWordCount} palavras, ${processedCharCount} caracteres)`;
}
</script>
</body>
</html>